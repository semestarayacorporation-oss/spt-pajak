<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart SPT Pajak - INTERNAL LAPORAN KEUANGAN OTOMATIS</title>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://konsulat.vercel.app/">
    <meta property="og:title" content="Smart SPT Pajak - Hitung Otomatis">
    <meta property="og:description" content="Aplikasi Hitung Pajak Badan & Laporan Keuangan Otomatis. Gratis & Cepat.">
    <meta property="og:image" content="https://spt-pajak.vercel.app/promo_gemini.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://konsulat.vercel.app/">
    <meta property="twitter:title" content="Smart SPT Pajak - Hitung Otomatis">
    <meta property="twitter:description" content="Aplikasi Hitung Pajak Badan & Laporan Keuangan Otomatis. Gratis & Cepat.">
    <meta property="twitter:image" content="https://spt-pajak.vercel.app/promo_gemini.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- SECURITY SCRIPT: ANTI-THEFT & ANTI-DEBUG -->
    <script>
        // Disable Right Click
        document.addEventListener('contextmenu', event => event.preventDefault());

        // Disable Keyboard Shortcuts for Developer Tools
        document.onkeydown = function(e) {
            // F12
            if(e.keyCode == 123) {
                return false;
            }
            // Ctrl+Shift+I
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            // Ctrl+Shift+C
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) {
                return false;
            }
            // Ctrl+Shift+J
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            // Ctrl+U
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; } /* Disable Text Selection */
        .currency-input { font-family: 'Courier New', monospace; font-weight: bold; letter-spacing: 0.5px; }
        .transition-all { transition: all 0.5s ease-in-out; }
        .balance-ok { border-color: #22c55e; background-color: #f0fdf4; }
        .balance-err { border-color: #ef4444; background-color: #fef2f2; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Paper Effect */
        .paper-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1), inset 0 0 40px rgba(0,0,0,0.05); }
        .dashed-line { border-bottom: 2px dashed #cbd5e1; }
        
        /* Marketing Gradients */
        .bg-premium { background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); color: #5c4506; }
        .bg-promo { background: linear-gradient(to right, #1e3a8a, #3b82f6); }
        
        /* Floating CTA */
        .floating-cta { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }

        /* Modern App Title */
        .app-title-gradient {
            background: linear-gradient(to right, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 2px 4px rgba(0,0,0,0.1);
        }

        /* Sequential Reveal Classes */
        .section-hidden { 
            display: none;
            opacity: 0; 
            transform: translateY(20px); 
        }
        .section-visible { 
            display: block;
            animation: fadeInUp 0.5s forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex overflow-hidden">

    <!-- MODAL MARKETING (UPSELL) -->
    <div id="upsell-modal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden transform transition-all scale-100 relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            
            <div class="bg-gradient-to-r from-blue-900 to-indigo-800 p-6 text-white text-center">
                <i data-lucide="file-check" class="w-16 h-16 mx-auto mb-3 text-yellow-400"></i>
                <h3 class="text-2xl font-bold">Laporan SPT Keuangan Siap</h3>
                <p class="text-blue-200 text-sm mt-1">Pilih format unduhan Anda.</p>
            </div>
            
            <div class="p-6 space-y-4">
                <div class="flex items-center gap-3 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                    <i data-lucide="file-spreadsheet" class="text-gray-500 w-6 h-6"></i>
                    <div class="text-sm">
                        <span class="font-bold text-gray-800">Smart SPT Pajak ini (gratis)</span>
                        <p class="text-gray-500 text-xs">Menghitung Cepat Laporan Keuangan instan input Coretax.</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3 p-4 bg-yellow-50 border border-yellow-200 rounded-xl ring-2 ring-yellow-400 relative">
                    <div class="absolute -top-3 -right-2 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded-full uppercase">Produk Jadi</div>
                    <i data-lucide="star" class="text-yellow-600 w-8 h-8 fill-yellow-500"></i>
                    <div class="flex-1">
                        <span class="font-bold text-gray-900 text-lg">Laba Rugi & Neraca SPT Pajak</span>
                        <p class="text-gray-600 text-xs mb-2">Laporan Keuangan PDF Siap Printing + Tanda tangan + Stempel</p>
                        <a href="https://wa.me/62817271284?text=Halo%20Admin%2C%20saya%20tertarik%20dengan%20Paket%20Laporan%20Keuangan%20Siap%20Cetak%20(PDF%20Resmi)." target="_blank" class="block w-full bg-blue-600 hover:bg-blue-700 text-white text-center py-2 rounded-lg font-bold text-sm shadow">
                            Download Laporan Keuangan SPT >> Terima Beres!
                        </a>
                    </div>
                </div>

                <div class="text-center pt-2">
                    <button onclick="realDownload()" class="text-xs text-gray-400 underline hover:text-red-500 text-center leading-tight">
                        Tidak terima kasih, saya biarkan Npwp sy muncul DENDA saja & bertambah Bunga pajak.
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="w-80 bg-slate-900 text-white flex flex-col shadow-2xl z-20 flex-shrink-0 relative">
        <div class="p-6 border-b border-slate-800 bg-slate-950">
            <h2 class="text-2xl font-extrabold flex items-center gap-2 app-title-gradient">
                <i data-lucide="zap" class="text-yellow-400 fill-yellow-400"></i> Smart SPT
            </h2>
            <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-wider font-bold">INTERNAL LAPORAN KEUANGAN OTOMATIS</p>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            
            <!-- SOCIAL HOOK (AUTO SUBSCRIBE LINKS) -->
            <div class="bg-indigo-900/30 p-3 rounded-lg border border-indigo-500/30 text-left space-y-2">
                <p class="text-xs text-indigo-200 italic">Dapatkan Tips Pajak Gratis & Update Aplikasi:</p>
                <div class="flex flex-col gap-2">
                    <a href="https://www.youtube.com/@mitrasukses2991/?sub_confirmation=1" target="_blank" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-xs flex items-center justify-center gap-2 transition w-full font-bold shadow hover:shadow-red-500/50">
                        <i data-lucide="youtube" class="w-3 h-3"></i> Subscribe Youtube
                    </a>
                    <div class="flex gap-2">
                         <a href="https://www.facebook.com/jakartaekspedisi/" target="_blank" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-2 py-1.5 rounded text-xs flex items-center justify-center gap-1 transition">
                            <i data-lucide="facebook" class="w-3 h-3"></i> FB
                        </a>
                        <a href="https://www.instagram.com/jakartaekspedisi/" target="_blank" class="flex-1 bg-pink-600 hover:bg-pink-700 text-white px-2 py-1.5 rounded text-xs flex items-center justify-center gap-1 transition">
                            <i data-lucide="instagram" class="w-3 h-3"></i> IG
                        </a>
                        <a href="https://www.tiktok.com/@jawi2712" target="_blank" class="flex-1 bg-black hover:bg-gray-800 text-white px-2 py-1.5 rounded text-xs flex items-center justify-center gap-1 transition border border-gray-700">
                            <i data-lucide="music-2" class="w-3 h-3"></i> TikTok
                        </a>
                    </div>
                </div>
            </div>

            <!-- NERACA MONITOR -->
            <div id="balance-monitor" class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                <p class="text-[10px] uppercase font-bold text-slate-400 mb-2">Status Neraca (L1)</p>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-slate-300">Aset:</span>
                    <span id="mon-aset" class="font-mono text-xs">0</span>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-slate-300">Passiva:</span>
                    <span id="mon-passiva" class="font-mono text-xs">0</span>
                </div>
                <div id="balance-badge" class="mt-2 w-full py-1 text-center rounded text-xs font-bold bg-gray-600 text-gray-300">
                    Belum Diisi
                </div>
                <p class="text-[9px] text-slate-500 mt-2 italic text-center">
                    Rumus: Aset = Kewajiban + Modal + Laba
                </p>
            </div>

            <!-- NAV LINKS -->
            <nav class="space-y-1">
                <button onclick="goToStep(1)" id="nav-btn-1" class="w-full flex items-center gap-3 p-2 rounded bg-slate-800 text-xs text-white font-bold transition group border-l-4 border-blue-500">
                    <span class="w-5 h-5 rounded-full bg-blue-600 flex items-center justify-center text-[10px] text-white">1</span> 
                    Profil & Tarif Berlaku
                </button>
                <button onclick="goToStep(2)" id="nav-btn-2" class="w-full flex items-center gap-3 p-2 rounded hover:bg-slate-800 text-xs text-slate-400 transition group border-l-4 border-transparent" disabled>
                    <span class="w-5 h-5 rounded-full bg-slate-700 flex items-center justify-center text-[10px] text-white group-hover:bg-slate-600">2</span> 
                    Laba Rugi & Neraca
                </button>
                <button onclick="goToStep(3)" id="nav-btn-3" class="w-full flex items-center gap-3 p-2 rounded hover:bg-slate-800 text-xs text-slate-400 transition group border-l-4 border-transparent" disabled>
                    <span class="w-5 h-5 rounded-full bg-slate-700 flex items-center justify-center text-[10px] text-white group-hover:bg-slate-600">3</span> 
                    Kredit & Finalisasi
                </button>
            </nav>

            <!-- PROMOSI APLIKASI LAIN -->
            <div class="pt-4 border-t border-slate-800">
                <p class="text-[10px] text-slate-500 uppercase font-bold px-1 mb-2 text-center">APLIKASI Tersedia</p>
                <div class="grid grid-cols-2 gap-2">
                    <a href="https://konsulat.vercel.app/" target="_blank" class="bg-slate-800 hover:bg-slate-700 p-2 rounded-lg flex flex-col items-center justify-center text-center gap-1 transition group border border-slate-700">
                        <i data-lucide="pen-tool" class="w-4 h-4 text-purple-400 group-hover:scale-110 transition"></i>
                        <span class="text-[9px] text-slate-300 leading-tight">Stempel & TTD Otomatis</span>
                    </a>
                    <a href="https://konsulat.vercel.app/" target="_blank" class="bg-slate-800 hover:bg-slate-700 p-2 rounded-lg flex flex-col items-center justify-center text-center gap-1 transition group border border-slate-700">
                        <i data-lucide="home" class="w-4 h-4 text-orange-400 group-hover:scale-110 transition"></i>
                        <span class="text-[9px] text-slate-300 leading-tight">Notaris Tanah</span>
                    </a>
                    <a href="https://konsulat.vercel.app/" target="_blank" class="bg-slate-800 hover:bg-slate-700 p-2 rounded-lg flex flex-col items-center justify-center text-center gap-1 transition group border border-slate-700">
                        <i data-lucide="gift" class="w-4 h-4 text-pink-400 group-hover:scale-110 transition"></i>
                        <span class="text-[9px] text-slate-300 leading-tight">Hitung Hibah</span>
                    </a>
                    <a href="https://konsulat.vercel.app/" target="_blank" class="bg-slate-800 hover:bg-slate-700 p-2 rounded-lg flex flex-col items-center justify-center text-center gap-1 transition group border border-slate-700">
                        <i data-lucide="file-text" class="w-4 h-4 text-cyan-400 group-hover:scale-110 transition"></i>
                        <span class="text-[9px] text-slate-300 leading-tight">Laporan PDF</span>
                    </a>
                </div>
            </div>

            <!-- TAX MONITOR -->
            <div class="bg-gradient-to-br from-blue-900 to-slate-900 p-4 rounded-xl border border-blue-800 shadow-lg relative overflow-hidden group cursor-pointer mt-4">
                <div class="absolute top-0 right-0 bg-yellow-400 text-black text-[9px] font-bold px-2 py-0.5 rounded-bl">PRO FEATURE</div>
                <p class="text-xs text-blue-200 mb-1 flex items-center gap-1">
                     <i data-lucide="star" class="w-3 h-3 text-yellow-400 fill-current"></i> IDR/$ Estimasi Bayar Pajaknya
                </p>
                <div class="text-2xl font-mono font-bold text-white tracking-tighter group-hover:text-yellow-300 transition" id="live-tax">Rp 0</div>
                <div class="mt-2 pt-2 border-t border-blue-800/50 flex justify-between text-[9px] text-blue-300">
                    <span class="w-full" id="active-scheme-label">-</span>
                </div>
                <!-- HIDDEN LINK ON HOVER -->
                <div class="max-h-0 overflow-hidden group-hover:max-h-20 transition-all duration-500 ease-in-out">
                    <a href="https://wa.me/62817271284?text=Saya%20ingin%20konsultasi%20perencanaan%20pajak%20untuk%20mengurangi%20pembayaran." target="_blank" class="block text-[10px] text-yellow-300 underline mt-2 text-center hover:text-white">
                        Ingin kurangi bayar Pajak ? Konsultasi Perencanaan hitung
                    </a>
                </div>
            </div>

        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative bg-gray-100">
        <header class="bg-white p-4 border-b flex justify-between items-center px-8 shadow-sm z-10 sticky top-0">
            <h1 class="font-bold text-xl text-gray-800 flex items-center gap-2">
                SPT Tahunan
                <span class="bg-green-100 text-green-800 text-[10px] px-2 py-0.5 rounded-full border border-green-200 font-bold uppercase tracking-wider">Menghitung Instan</span>
            </h1>
            <button onclick="sendWhatsapp()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg transition-all transform hover:scale-105 floating-cta">
                <i data-lucide="message-circle"></i> Simpan & Download
            </button>
        </header>

        <div class="flex-1 overflow-y-auto p-8 pb-40 space-y-10 scroll-smooth" id="main-scroll">
            
            <!-- MARKETING BANNER 1 -->
            <div class="bg-promo text-white p-5 rounded-xl shadow-lg flex justify-between items-center transform transition hover:scale-[1.005] cursor-pointer border border-blue-400">
                <div class="flex items-center gap-4">
                    <div class="bg-white/20 p-3 rounded-full shadow-inner"><i data-lucide="help-circle" class="w-6 h-6 text-yellow-300"></i></div>
                    <div>
                        <h4 class="font-bold text-base text-yellow-300">Tetapkan jadi manfaat Tarif UMKM 0,5% Lebih Ringan.</h4>
                        <p class="text-xs text-blue-100 mt-1">Salah pilih tarif bisa mengakibatkan denda besar. Pastikan status Anda valid.</p>
                    </div>
                </div>
                <button class="bg-white text-blue-700 px-5 py-2.5 rounded-lg text-xs font-bold hover:bg-blue-50 shadow-lg transition-all transform hover:-translate-y-0.5">Proses Ketetapan Fasilitas 0,5%</button>
            </div>

            <!-- STEP 1: PROFIL & TARIF -->
            <div id="step-1" class="section-visible">
                <section class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 relative overflow-hidden transition-all duration-500">
                    <h3 class="font-bold text-gray-800 mb-6 border-b pb-3 text-lg">1. Profil & Tarif Berlaku</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Bentuk Usaha</label>
                            <select id="inp-entity" class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none transition shadow-sm" onchange="runEngine()">
                                <option value="PT">PT (Perseroan Terbatas)</option>
                                <option value="CV">CV (Persekutuan Komanditer)</option>
                                <option value="CV">Firma</option>
                                <option value="CV">Koperasi</option>
                                <option value="CV">Yayasan / Badan Nirlaba</option>
                                <option value="CV">BUMDes / BUMDesma</option>
                                <option value="CV">Persekutuan Perdata</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Tahun Terdaftar</label>
                            <input type="number" id="inp-reg-year" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" value="2023" onkeyup="runEngine()">
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <label class="block text-sm font-bold text-gray-700 uppercase mb-2 flex items-center gap-1">
                            Pendapatan Setahun (OMZET Bruto) <i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-current"></i>
                        </label>
                        <input type="text" id="inp-omzet" class="currency-input w-full p-4 border-2 border-yellow-400 bg-yellow-50 rounded-xl text-right focus:border-yellow-500 focus:ring-4 focus:ring-yellow-200 outline-none transition-all text-2xl text-gray-900 shadow-inner" placeholder="0" onkeyup="formatAndReact(this)">
                    </div>
                    
                    <div class="flex gap-4 mb-4">
                        <label id="card-umkm" class="flex-1 border-2 border-gray-200 p-4 rounded-xl cursor-pointer bg-gray-50 relative overflow-hidden transition-all hover:shadow-md hover:border-green-400">
                            <div class="flex items-center gap-3">
                                <input type="radio" name="scheme" value="UMKM" class="w-5 h-5 text-green-600 accent-green-600" onchange="runEngine()">
                                <div>
                                    <div class="font-bold text-gray-800">Final UMKM 0,5%</div>
                                    <div class="text-xs text-gray-500">Dari Omzet Bruto</div>
                                </div>
                            </div>
                            <div id="blocker-umkm" class="hidden absolute inset-0 bg-gray-200/90 flex items-center justify-center text-xs font-bold text-red-600 backdrop-blur-[1px]">
                                <i data-lucide="lock" class="w-3 h-3 mr-1"></i> Syarat Tidak Terpenuhi
                            </div>
                        </label>
                        <label id="card-umum" class="flex-1 border-2 border-blue-200 bg-blue-50 p-4 rounded-xl cursor-pointer transition-all hover:shadow-md hover:border-blue-400">
                            <div class="flex items-center gap-3">
                                <input type="radio" name="scheme" value="UMUM" class="w-5 h-5 text-blue-600 accent-blue-600" checked onchange="runEngine()">
                                <div>
                                    <div class="font-bold text-blue-900">Tarif Umum 11 & 22%</div>
                                    <div class="text-xs text-blue-600">Laba Rugi (Pasal 17/31E)</div>
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="text-center pt-4 border-t border-gray-100">
                        <button onclick="nextToFinancial()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full font-bold shadow-md hover:shadow-lg transition-all flex items-center gap-2 mx-auto">
                            Lanjut ke Laba Rugi <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </section>
            </div>

            <!-- GROUP: LABA RUGI & NERACA -->
            <div id="group-financial" class="section-hidden transition-all duration-700">
                
                <!-- 2. LABA RUGI (EYE CATCHING BACKGROUND) -->
                <section id="section-2" class="bg-gradient-to-br from-indigo-600 to-blue-700 p-8 rounded-2xl shadow-2xl border-none transition-all relative overflow-hidden mb-8">
                    <!-- Watermark Marketing -->
                    <div class="absolute top-4 right-4 text-white/10 font-bold text-6xl pointer-events-none select-none">PREVIEW</div>
                    
                    <h3 class="font-bold text-white mb-6 border-b border-indigo-400/50 pb-4 flex justify-between items-center relative z-10">
                        <span class="text-xl">2. Laba Rugi & Fiskal setahun ini</span>
                        <span id="badge-laba" class="text-xs bg-indigo-800/50 px-3 py-1 rounded border border-indigo-400 text-indigo-100">Netto: Rp 0</span>
                    </h3>
                    
                    <!-- INPUT FORM (Wrapper White for Readability) -->
                    <div class="bg-white/10 p-6 rounded-xl backdrop-blur-sm border border-white/20 mb-8 relative z-10">
                        <!-- Row 1: HPP Alone -->
                        <div class="mb-6">
                            <label class="block text-xs font-bold text-blue-50 uppercase mb-2">HP.Pokok BYR Keluar</label>
                            <input type="text" id="inp-hpp" class="currency-input w-full p-3 border-none rounded-lg text-right focus:ring-2 focus:ring-yellow-400 outline-none shadow-inner bg-white/90 text-gray-900 text-lg" placeholder="0" onkeyup="formatAndReact(this)">
                            <p class="text-[10px] text-blue-100 mt-1.5 italic flex items-center gap-1 opacity-80"><i data-lucide="info" class="w-3 h-3"></i> Estimasi wajar: 79% dari Omzet</p>
                        </div>

                        <!-- Row 2: Gaji & Biaya (2 Cols) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-xs font-bold text-blue-50 uppercase mb-2">PengGAJIan/upah</label>
                                <input type="text" id="inp-gaji" class="currency-input w-full p-3 border-none rounded-lg text-right focus:ring-2 focus:ring-yellow-400 outline-none shadow-inner bg-white/90 text-gray-900" placeholder="0" onkeyup="formatAndReact(this)">
                                <p class="text-[10px] text-blue-100 mt-1.5 italic flex items-center gap-1 opacity-80"><i data-lucide="info" class="w-3 h-3"></i> Estimasi wajar: 10% dari Omzet</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-blue-50 uppercase mb-2">Biaya Lainnya</label>
                                <input type="text" id="inp-biaya" class="currency-input w-full p-3 border-none rounded-lg text-right focus:ring-2 focus:ring-yellow-400 outline-none shadow-inner bg-white/90 text-gray-900" placeholder="0" onkeyup="formatAndReact(this)">
                                <p class="text-[10px] text-blue-100 mt-1.5 italic flex items-center gap-1 opacity-80"><i data-lucide="info" class="w-3 h-3"></i> Estimasi wajar: 5% dari Omzet</p>
                            </div>
                        </div>

                        <!-- Row 3: Evaluasi (2 Cols) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-red-200 uppercase mb-2">Evaluasi Positif (+)</label>
                                <input type="text" id="inp-kor-pos" class="currency-input w-full p-3 border-none rounded-lg text-right focus:ring-2 focus:ring-red-400 outline-none shadow-inner bg-white/90 text-gray-900" placeholder="0" onkeyup="formatAndReact(this)">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-green-200 uppercase mb-2">Evaluasi Negatif (-)</label>
                                <input type="text" id="inp-kor-neg" class="currency-input w-full p-3 border-none rounded-lg text-right focus:ring-2 focus:ring-green-400 outline-none shadow-inner bg-white/90 text-gray-900" placeholder="0" onkeyup="formatAndReact(this)">
                            </div>
                        </div>
                    </div>

                    <!-- PREVIEW LAPORAN LABA RUGI (PAPER EFFECT - POP OUT) -->
                    <div class="relative bg-white paper-shadow border-none p-8 rounded-sm max-w-2xl mx-auto transform hover:scale-[1.01] transition-transform duration-500 group z-20">
                        <!-- Premium Badge on Paper -->
                        <div class="absolute -right-2 -top-2 bg-yellow-400 text-yellow-900 text-[10px] font-bold px-3 py-1 shadow-md transform rotate-12 group-hover:scale-110 transition z-30 shadow-sm">Lembar Upload Coretax SPT</div>
                        
                        <!-- Paper Header -->
                        <div class="text-center mb-6 border-b-2 border-double border-slate-800 pb-2">
                            <h4 class="font-serif font-bold text-lg text-slate-800">LAPORAN LABA RUGI</h4>
                            <p class="text-xs text-slate-500">Periode Berakhir 31 Desember</p>
                        </div>

                        <!-- Content -->
                        <div class="space-y-2 font-mono text-sm text-slate-700">
                            <div class="flex justify-between">
                                <span>Pendapatan Usaha</span>
                                <span class="font-bold" id="prev-omzet">0</span>
                            </div>
                            <div class="flex justify-between text-slate-500">
                                <span class="pl-4">Harga Pokok Penjualan (HPP)</span>
                                <span id="prev-hpp">(0)</span>
                            </div>
                            <div class="flex justify-between font-bold border-t border-slate-300 pt-1 pb-2">
                                <span>LABA KOTOR</span>
                                <span id="prev-laba-kotor">0</span>
                            </div>

                            <div class="text-xs text-slate-500 uppercase font-bold mt-2">Beban Operasional:</div>
                            <div class="flex justify-between pl-4">
                                <span>Beban Gaji & Upah</span>
                                <span id="prev-gaji">(0)</span>
                            </div>
                            <div class="flex justify-between pl-4">
                                <span>Beban Usaha Lainnya</span>
                                <span id="prev-biaya">(0)</span>
                            </div>
                            <div class="flex justify-between font-bold border-t border-slate-800 pt-2 mt-2 text-base">
                                <span>LABA BERSIH (KOMERSIAL)</span>
                                <span id="prev-laba-bersih">0</span>
                            </div>
                            
                            <div class="dashed-line my-4"></div>
                            
                            <!-- TAX CALCULATION (ESTIMATE) -->
                            <div class="text-xs text-slate-500 uppercase font-bold mt-2">Ketentuan Pajak (Estimasi):</div>
                            <div class="bg-yellow-50 p-3 rounded border border-yellow-100 space-y-2 mt-1">
                                <div class="flex justify-between text-xs">
                                    <span class="text-slate-600">Dasar Pengenaan Pajak (DPP)</span>
                                    <span id="prev-dpp" class="font-mono font-bold">0</span>
                                </div>
                                <div class="flex justify-between text-xs">
                                    <span class="text-slate-600">Tarif yang Berlaku</span>
                                    <span id="prev-tarif" class="font-mono text-blue-600 font-bold">-</span>
                                </div>
                                <!-- PPh Terutang Line Removed as requested for paper preview -->
                            </div>
                            
                            <!-- Marketing Footer in Paper -->
                            <div class="mt-6 pt-4 border-t border-slate-200 text-center">
                                <button onclick="triggerUpsell()" class="mt-1 text-blue-600 text-xs font-bold underline hover:text-blue-800">Download Laporan Keuangan SPT Siap Cetak dan Tandatangan &rarr;</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 3. NERACA (BALANCE SHEET) -->
                <section id="section-neraca" class="bg-gradient-to-br from-yellow-50 to-orange-100 p-6 rounded-xl shadow-sm border border-yellow-200 mt-8">
                    <div class="flex justify-between items-center mb-6 border-b border-yellow-300 pb-2">
                        <h3 class="font-bold text-yellow-900 flex items-center gap-2 text-lg">
                            <span>3. NERACA (Kesehatan keuangan)</span>
                            <span id="balance-indicator" class="text-xs font-bold px-3 py-1 rounded-full bg-white text-gray-500 shadow-sm border">Belum seimbang</span>
                        </h3>
                        <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg hover:shadow-md transition border border-yellow-300">
                            <input type="checkbox" id="auto-balance-toggle" class="w-4 h-4 text-orange-600 rounded focus:ring-orange-500" onchange="runEngine()">
                            <span class="text-xs font-bold text-orange-800">Isi Otomatis (Estimasi)</span>
                        </label>
                    </div>
                    
                    <!-- CATATAN REKOMENDASI NERACA -->
                    <div class="bg-white/60 border-l-4 border-yellow-500 p-4 mb-8 rounded-r-lg backdrop-blur-sm shadow-sm">
                        <div class="flex items-start">
                            <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-600 mr-3 mt-0.5"></i>
                            <div>
                                <p class="text-xs font-bold text-yellow-900 mb-1 italic">_Strategi planning Keuangan_</p>
                                <p class="text-xs text-yellow-800 leading-relaxed font-medium" id="neraca-recommendation">
                                    Menunggu data...
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Sisi Aset -->
                        <div class="space-y-4 bg-white/50 p-4 rounded-xl border border-yellow-200/50">
                            <h4 class="text-sm font-bold text-blue-900 uppercase border-b border-blue-200 pb-2 mb-2">A. Aset / Harta</h4>
                            <div>
                                <label class="block text-xs text-gray-600 font-semibold mb-1">Kas & Setara Kas</label>
                                <input type="text" id="inp-kas" class="currency-input w-full p-2.5 border border-blue-100 rounded-lg text-right bg-white focus:ring-2 focus:ring-blue-400 outline-none" placeholder="0" onkeyup="formatAndReact(this)">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 font-semibold mb-1">Piutang & Persediaan (Aset Lancar)</label>
                                <input type="text" id="inp-aset-lancar-lain" class="currency-input w-full p-2.5 border border-blue-100 rounded-lg text-right bg-white focus:ring-2 focus:ring-blue-400 outline-none" placeholder="0" onkeyup="formatAndReact(this)">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 font-semibold mb-1">Aset Tetap (Tanah, Bangunan, Mesin)</label>
                                <input type="text" id="inp-aset-tetap" class="currency-input w-full p-2.5 border border-blue-100 rounded-lg text-right bg-white focus:ring-2 focus:ring-blue-400 outline-none" placeholder="0" onkeyup="formatAndReact(this)">
                            </div>
                            <div class="bg-blue-100 p-3 rounded-lg flex justify-between items-center mt-2 border border-blue-200">
                                <span class="text-xs font-bold text-blue-900">Total Aset</span>
                                <span id="val-total-aset" class="font-mono font-bold text-blue-900 text-sm">0</span>
                            </div>
                        </div>

                        <!-- Sisi Passiva -->
                        <div class="space-y-4 bg-white/50 p-4 rounded-xl border border-yellow-200/50">
                            <h4 class="text-sm font-bold text-red-900 uppercase border-b border-red-200 pb-2 mb-2">B. Kewajiban & Ekuitas</h4>
                            <div>
                                <label class="block text-xs text-gray-600 font-semibold mb-1">Utang Jangka Pendek & Panjang</label>
                                <input type="text" id="inp-liabilitas" class="currency-input w-full p-2.5 border border-red-100 rounded-lg text-right bg-white focus:ring-2 focus:ring-red-400 outline-none" placeholder="0" onkeyup="formatAndReact(this)">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 font-semibold mb-1">Modal Saham / Modal Disetor</label>
                                <input type="text" id="inp-modal" class="currency-input w-full p-2.5 border border-red-100 rounded-lg text-right bg-white focus:ring-2 focus:ring-red-400 outline-none" placeholder="0" onkeyup="formatAndReact(this)">
                            </div>
                            
                            <div class="opacity-80">
                                <label class="block text-xs text-green-700 font-bold mb-1">Laba Tahun Berjalan (Otomatis)</label>
                                <input type="text" id="inp-laba-berjalan" class="currency-input w-full p-2.5 border border-green-200 bg-green-50 rounded-lg text-right font-bold text-green-800" readonly value="0">
                            </div>
                            <div class="bg-red-100 p-3 rounded-lg flex justify-between items-center mt-2 border border-red-200">
                                <span class="text-xs font-bold text-red-900">Total Passiva</span>
                                <span id="val-total-passiva" class="font-mono font-bold text-red-900 text-sm">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Next Button Section 2 & 3 -->
                    <div class="text-center pt-6 border-t border-yellow-300/50 mt-6 flex justify-between">
                        <button onclick="goToStep(1)" class="text-yellow-800 hover:text-yellow-900 font-medium px-6 py-2">
                            &larr; Kembali
                        </button>
                        <button onclick="nextToFinal()" class="bg-orange-600 hover:bg-orange-700 text-white px-8 py-3 rounded-full font-bold shadow-md hover:shadow-lg transition-all flex items-center gap-2">
                            Lanjut ke Kredit & Finalisasi <i data-lucide="arrow-down" class="w-4 h-4"></i>
                        </button>
                    </div>
                </section>
            </div>

            <!-- GROUP: FINALISASI (HIDDEN INITIALLY) -->
            <div id="group-final" class="section-hidden transition-all duration-700">
                <!-- 4. KREDIT PAJAK -->
                <section id="section-4" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mt-8">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">4. Kredit Yg pernah bayar/diPotong jd pengurang pjk</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bupot PPh 22/23 (L3)</label>
                            <input type="text" id="inp-l3" class="currency-input w-full p-3 border rounded-lg text-right focus:ring-2 focus:ring-purple-500 outline-none" placeholder="0" onkeyup="formatAndReact(this)">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Angsuran PPh 25 (L6)</label>
                            <input type="text" id="inp-l6" class="currency-input w-full p-3 border rounded-lg text-right focus:ring-2 focus:ring-orange-500 outline-none" placeholder="0" onkeyup="formatAndReact(this)">
                        </div>
                    </div>
                </section>

                <!-- MARKETING BANNER 2 -->
                <div class="bg-gradient-to-r from-slate-900 to-slate-800 text-white p-5 rounded-xl shadow-lg flex justify-between items-center border border-slate-700 mt-8">
                    <div class="flex items-center gap-4">
                        <div class="bg-red-500/20 p-3 rounded-lg"><i data-lucide="file-warning" class="w-6 h-6 text-red-400"></i></div>
                        <div>
                            <h4 class="font-bold text-sm text-red-100">Punya Denda Pajak Menumpuk?</h4>
                            <p class="text-xs text-slate-400 mt-0.5">Jangan biarkan aset disita. Kami bantu proses penghapusan/pengurangan denda.</p>
                        </div>
                    </div>
                    <button class="bg-red-600 text-white px-5 py-2 rounded-lg text-xs font-bold hover:bg-red-700 shadow-lg shadow-red-900/50 transition">APP Penghapusan Denda</button>
                </div>

                <!-- 5. FINAL SUMMARY -->
                <section id="section-summary" class="bg-slate-900 text-white p-8 rounded-2xl shadow-xl border border-slate-700 mt-8 mb-20 relative overflow-hidden">
                    <!-- Background Glow -->
                    <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl pointer-events-none"></div>
                    
                    <div class="flex justify-between items-end mb-6 relative z-10">
                        <h3 class="font-bold text-xl flex items-center gap-2">
                            <i data-lucide="file-check" class="text-green-400"></i> Ringkasan Induk
                        </h3>
                        <div class="text-right">
                            <p class="text-[10px] text-slate-400 uppercase tracking-widest">Status Akhir</p>
                            <h2 class="text-3xl font-extrabold" id="out-status">NIHIL</h2>
                        </div>
                    </div>

                    <div class="space-y-3 font-mono text-sm border-t border-slate-700 pt-6 relative z-10">
                        <div class="flex justify-between text-slate-300"><span>PKP / DPP</span> <span id="out-pkp" class="text-white font-bold">0</span></div>
                        <div class="flex justify-between text-slate-300"><span>PPh Terutang</span> <span id="out-tax" class="text-white font-bold">0</span></div>
                        <div class="flex justify-between text-green-400"><span>Total Kredit</span> <span id="out-credit">0</span></div>
                        <div class="flex justify-between text-2xl font-bold pt-4 border-t border-slate-700 mt-4">
                            <span class="text-slate-200">Nilai Akhir</span> <span id="out-balance">Rp 0</span>
                        </div>
                    </div>
                    
                    <div class="mt-8 text-center relative z-10">
                        <button onclick="triggerUpsell()" class="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:shadow-green-500/30 transition-all transform hover:scale-105">
                            Pengaturan Akhir
                        </button>
                    </div>

                    <div class="mt-4 text-center">
                        <button onclick="goToStep(3)" class="text-slate-500 hover:text-slate-300 text-xs underline">
                            &larr; Kembali ke Neraca
                        </button>
                    </div>
                </section>
            </div>

        </div>
    </main>

    <script>
        lucide.createIcons();

        // CONSTANTS & UTILS
        const LIMIT_UMKM = 4800000000;
        const LIMIT_31E = 50000000000;
        const CURRENT_YEAR = 2025;
        const parse = (val) => parseFloat(val?.replace(/\./g, '').replace(/,/g, '') || 0);
        const format = (num) => num.toLocaleString('id-ID');

        // STATE & NAVIGATION
        let currentStep = 1;

        function goToStep(step) {
            // Validate step 1 before proceeding
            if (currentStep === 1 && step > 1) {
                const omzet = parse(document.getElementById('inp-omzet').value);
                if (omzet <= 0) {
                    alert("Mohon isi Pendapatan Setahun (OMZET) terlebih dahulu.");
                    return;
                }
            }
            
            // Logic for showing/hiding sections based on step
            // Step 1: Profil (id=step-1)
            // Step 2 & 3: Financial Group (id=group-financial)
            // Step 4 & 5: Final Group (id=group-final)

            const step1 = document.getElementById('step-1');
            const groupFinancial = document.getElementById('group-financial');
            const groupFinal = document.getElementById('group-final');

            // Reset all
            step1.classList.remove('section-visible'); step1.classList.add('section-hidden');
            groupFinancial.classList.remove('section-visible'); groupFinancial.classList.add('section-hidden');
            groupFinal.classList.remove('section-visible'); groupFinal.classList.add('section-hidden');

            if (step === 1) {
                step1.classList.remove('section-hidden');
                step1.classList.add('section-visible');
            } else if (step === 2 || step === 3) {
                groupFinancial.classList.remove('section-hidden');
                groupFinancial.classList.add('section-visible');
                // Optional: Scroll to specific section within group
                if(step === 2) document.getElementById('section-2').scrollIntoView({ behavior: 'smooth' });
                if(step === 3) document.getElementById('section-neraca').scrollIntoView({ behavior: 'smooth' });
            } else if (step === 4 || step === 5) {
                groupFinal.classList.remove('section-hidden');
                groupFinal.classList.add('section-visible');
                if(step === 4) document.getElementById('section-4').scrollIntoView({ behavior: 'smooth' });
            }

            // Update nav sidebar styles
            for(let i=1; i<=4; i++) {
                 const btn = document.getElementById(`nav-btn-${i}`);
                 if(btn) {
                     // Basic reset
                     btn.classList.remove('bg-slate-800', 'text-white', 'border-blue-500');
                     btn.classList.add('text-slate-400', 'border-transparent');
                 }
            }
            
            // Highlight active nav
            const activeBtn = document.getElementById(`nav-btn-${step > 3 ? 4 : step}`); // Map step 5 to button 4
            if(activeBtn) {
                activeBtn.classList.remove('text-slate-400', 'border-transparent');
                activeBtn.classList.add('bg-slate-800', 'text-white', 'border-blue-500');
                activeBtn.disabled = false;
            }

            currentStep = step;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function nextToFinancial() {
            const omzet = parse(document.getElementById('inp-omzet').value);
            if (omzet <= 0) {
                alert("Mohon isi Pendapatan Setahun (OMZET) terlebih dahulu untuk melanjutkan.");
                return;
            }
            goToStep(2);
        }

        function nextToFinal() {
            goToStep(4);
        }

        function sendWhatsapp() {
            const phone = "62817271284";
            const text = "Halo Admin Smart SPT, saya ingin Simpan & Download laporan keuangan saya.\n\nLink Referensi: https://konsulat.vercel.app/";
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(text)}`, '_blank');
        }

        // Modal Logic
        function triggerUpsell() { document.getElementById('upsell-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('upsell-modal').classList.add('hidden'); }
        function realDownload() {
            const badgeText = document.getElementById('balance-badge').innerText;
            if (badgeText.includes("SELISIH") || badgeText.includes("Belum")) {
                if(!confirm("Neraca belum seimbang. Lanjutkan download CSV Mentah?")) return;
            }
            alert("Sedang mengunduh file CSV basic...");
            closeModal();
        }

        // Engine Triggers
        function formatAndReact(el) {
            let original = el.value.replace(/\D/g, '');
            if(original) el.value = parseInt(original).toLocaleString('id-ID');
            runEngine();
        }

        function runEngine() {
            // DATA GATHERING
            const entity = document.getElementById('inp-entity') ? document.getElementById('inp-entity').value : 'PT';
            const regYear = parseInt(document.getElementById('inp-reg-year') ? document.getElementById('inp-reg-year').value : 0) || 0;
            const omzet = parse(document.getElementById('inp-omzet') ? document.getElementById('inp-omzet').value : '0');
            
            const hpp = parse(document.getElementById('inp-hpp') ? document.getElementById('inp-hpp').value : '0');
            const gaji = parse(document.getElementById('inp-gaji') ? document.getElementById('inp-gaji').value : '0'); 
            const biaya = parse(document.getElementById('inp-biaya') ? document.getElementById('inp-biaya').value : '0');
            const korPos = parse(document.getElementById('inp-kor-pos') ? document.getElementById('inp-kor-pos').value : '0');
            const korNeg = parse(document.getElementById('inp-kor-neg') ? document.getElementById('inp-kor-neg').value : '0');

            const l3 = parse(document.getElementById('inp-l3') ? document.getElementById('inp-l3').value : '0');
            const l6 = parse(document.getElementById('inp-l6') ? document.getElementById('inp-l6').value : '0');

            // PROFIT CALCULATION
            const totalBiaya = gaji + biaya;
            const labaKotor = omzet - hpp;
            const labaKomersial = labaKotor - totalBiaya;
            const labaFiskal = labaKomersial + korPos - korNeg;
            
            if (document.getElementById('badge-laba')) document.getElementById('badge-laba').innerText = "Netto Komersial: Rp " + format(labaKomersial);
            if (document.getElementById('inp-laba-berjalan')) document.getElementById('inp-laba-berjalan').value = format(labaKomersial);

            // Update Preview Laba Rugi
            if (document.getElementById('prev-omzet')) document.getElementById('prev-omzet').innerText = format(omzet);
            if (document.getElementById('prev-hpp')) document.getElementById('prev-hpp').innerText = "(" + format(hpp) + ")";
            if (document.getElementById('prev-laba-kotor')) document.getElementById('prev-laba-kotor').innerText = format(labaKotor);
            if (document.getElementById('prev-gaji')) document.getElementById('prev-gaji').innerText = "(" + format(gaji) + ")";
            if (document.getElementById('prev-biaya')) document.getElementById('prev-biaya').innerText = "(" + format(biaya) + ")";
            if (document.getElementById('prev-laba-bersih')) document.getElementById('prev-laba-bersih').innerText = format(labaKomersial);
            
            // SCHEME VALIDATION
            let limitYears = (entity === 'PT') ? 3 : 4;
            let startYear = Math.max(regYear, 2018);
            let runningYear = (CURRENT_YEAR - startYear) + 1;
            let canUseUMKM = (runningYear <= limitYears) && (omzet <= LIMIT_UMKM);

            const radioUmkm = document.querySelector('input[value="UMKM"]');
            const radioUmum = document.querySelector('input[value="UMUM"]');
            const blocker = document.getElementById('blocker-umkm');

            if (blocker) {
                if (!canUseUMKM) {
                    blocker.classList.remove('hidden');
                    if (radioUmkm) radioUmkm.disabled = true;
                    if(radioUmkm && radioUmkm.checked && radioUmum) radioUmum.checked = true;
                } else {
                    blocker.classList.add('hidden');
                    if (radioUmkm) radioUmkm.disabled = false;
                }
            }

            // TAX CALCULATION
            const schemeEl = document.querySelector('input[name="scheme"]:checked');
            const scheme = schemeEl ? schemeEl.value : 'UMUM';
            let tax = 0;
            let pkp = 0;
            let dpp = 0;
            let schemeLabel = "";
            let tarifDisplay = "";

            if (scheme === 'UMKM') {
                tax = Math.floor(omzet * 0.005);
                schemeLabel = "Final 0,5%";
                dpp = omzet;
                tarifDisplay = "0,5% (Final PP 55)";
            } else {
                pkp = (labaFiskal > 0) ? Math.floor(labaFiskal/1000)*1000 : 0;
                dpp = pkp;
                
                if (pkp <= 0) {
                    tax = 0;
                    tarifDisplay = "Nihil (Rugi)";
                    schemeLabel = "Tarif Umum 11 & 22%";
                }
                else if (omzet <= 4800000000) {
                    tax = Math.floor(pkp * 0.11);
                    tarifDisplay = "Pasal 31E 11%";
                    schemeLabel = "Pasal 31E 11%";
                }
                else if (omzet > 50000000000) {
                    tax = Math.floor(pkp * 0.22);
                    tarifDisplay = "Tarif Normal 22% (Pasal 17)";
                    schemeLabel = "Tarif Normal 22% (Pasal 17)";
                }
                else {
                    let pkpFas = (4800000000 / omzet) * pkp;
                    if(pkpFas > pkp) pkpFas = pkp;
                    let pkpNon = pkp - pkpFas;
                    tax = Math.floor((pkpFas * 0.11) + (pkpNon * 0.22));
                    tarifDisplay = "Fasilitas Pasal 31E & 17";
                    schemeLabel = "Fasilitas Pasal 31E & 17";
                }
            }

            if (document.getElementById('prev-dpp')) document.getElementById('prev-dpp').innerText = format(dpp);
            if (document.getElementById('prev-tarif')) document.getElementById('prev-tarif').innerText = tarifDisplay;

            // NERACA AUTO-BALANCE LOGIC
            const autoBalanceToggle = document.getElementById('auto-balance-toggle');
            const autoBalance = autoBalanceToggle ? autoBalanceToggle.checked : false;
            const recBox = document.getElementById('neraca-recommendation');
            const inpKas = document.getElementById('inp-kas');
            const inpAsetLancar = document.getElementById('inp-aset-lancar-lain');
            const inpAsetTetap = document.getElementById('inp-aset-tetap');
            const inpLiabilitas = document.getElementById('inp-liabilitas');
            const inpModal = document.getElementById('inp-modal');
            
            // Heuristic Calc
            let estModal = Math.max(omzet * 0.05, 5000000);
            let estUtang = omzet * 0.02;
            let totalPasiva = estUtang + estModal + labaKomersial;
            let recText = "";

            if (totalPasiva < 0) {
                let deficit = Math.abs(totalPasiva) + 10000000;
                estModal += deficit;
                totalPasiva = estUtang + estModal + labaKomersial;
                recText = `Rugi fiskal terdeteksi. Modal Saham perlu minimal Rp ${format(estModal)} agar Neraca positif. `;
            } else {
                recText = `Rekomendasi Angka: Modal Rp ${format(estModal)} (5% Omzet) dan Utang Rp ${format(estUtang)}. `;
            }

            let estAsetTetap = omzet * 0.05; 
            let estAsetLancar = omzet * 0.05; 
            let estKas = totalPasiva - estAsetTetap - estAsetLancar;

            if (estKas < 0) {
                let shortfall = Math.abs(estKas) + 1000000;
                estKas = 1000000; 
                estModal += shortfall;
                recText += `Kekurangan aset dialihkan ke Modal (+Rp ${format(shortfall)}). `;
            } else {
                recText += `Sisa penyeimbang Rp ${format(estKas)} dimasukkan ke Kas.`;
            }
            if (recBox) recBox.innerText = recText;

            if (autoBalance && inpKas && inpAsetLancar && inpAsetTetap && inpLiabilitas && inpModal) {
                inpKas.value = format(estKas);
                inpAsetLancar.value = format(estAsetLancar);
                inpAsetTetap.value = format(estAsetTetap);
                inpLiabilitas.value = format(estUtang);
                inpModal.value = format(estModal);
                [inpKas, inpAsetLancar, inpAsetTetap, inpLiabilitas, inpModal].forEach(el => el.classList.add('bg-blue-50', 'text-blue-800'));
            } else if (inpKas && inpAsetLancar && inpAsetTetap && inpLiabilitas && inpModal) {
                [inpKas, inpAsetLancar, inpAsetTetap, inpLiabilitas, inpModal].forEach(el => el.classList.remove('bg-blue-50', 'text-blue-800'));
            }

            // Calculate Balance
            const kas = parse(inpKas ? inpKas.value : '0');
            const asetLancar = parse(inpAsetLancar ? inpAsetLancar.value : '0');
            const asetTetap = parse(inpAsetTetap ? inpAsetTetap.value : '0');
            const totalAset = kas + asetLancar + asetTetap;
            const liabilitas = parse(inpLiabilitas ? inpLiabilitas.value : '0');
            const modal = parse(inpModal ? inpModal.value : '0');
            const totalPassivaLive = liabilitas + modal + labaKomersial;
            const neracaDiff = totalAset - totalPassivaLive;
            const isBalanced = Math.abs(neracaDiff) < 100;

            if (document.getElementById('val-total-aset')) document.getElementById('val-total-aset').innerText = format(totalAset);
            if (document.getElementById('val-total-passiva')) document.getElementById('val-total-passiva').innerText = format(totalPassivaLive);
            if (document.getElementById('mon-aset')) document.getElementById('mon-aset').innerText = format(totalAset);
            if (document.getElementById('mon-passiva')) document.getElementById('mon-passiva').innerText = format(totalPassivaLive);

            const badgeBal = document.getElementById('balance-badge');
            const balanceInd = document.getElementById('balance-indicator');
            const sectionNeraca = document.getElementById('section-neraca');

            if (badgeBal && balanceInd && sectionNeraca) {
                if (isBalanced && totalAset > 0) {
                    badgeBal.className = "mt-2 w-full py-1 text-center rounded text-xs font-bold bg-green-600 text-white";
                    badgeBal.innerText = "BALANCED";
                    balanceInd.innerText = "Seimbang (OK)";
                    balanceInd.className = "text-xs font-bold px-3 py-1 rounded-full bg-green-100 text-green-700";
                    sectionNeraca.className = "bg-gradient-to-br from-yellow-50 to-orange-100 p-6 rounded-xl shadow-sm border-2 balance-ok mt-8";
                } else if (totalAset === 0) {
                    badgeBal.innerText = "Belum Diisi";
                    badgeBal.className = "mt-2 w-full py-1 text-center rounded text-xs font-bold bg-gray-600 text-gray-300";
                    balanceInd.innerText = "Belum seimbang";
                    sectionNeraca.className = "bg-gradient-to-br from-yellow-50 to-orange-100 p-6 rounded-xl shadow-sm border border-yellow-200 mt-8";
                } else {
                    badgeBal.className = "mt-2 w-full py-1 text-center rounded text-xs font-bold bg-red-600 text-white";
                    badgeBal.innerText = `SELISIH: ${format(neracaDiff)}`;
                    balanceInd.innerText = "Belum seimbang";
                    balanceInd.className = "text-xs font-bold px-3 py-1 rounded-full bg-red-100 text-red-700";
                    sectionNeraca.className = "bg-gradient-to-br from-yellow-50 to-orange-100 p-6 rounded-xl shadow-sm border-2 balance-err mt-8";
                }
            }

            // FINAL SUMMARY
            const credit = l3 + l6;
            const balance = tax - credit;

            if (document.getElementById('live-tax')) document.getElementById('live-tax').innerText = "Rp " + format(tax);
            if (document.getElementById('active-scheme-label')) document.getElementById('active-scheme-label').innerText = schemeLabel;
            
            if (document.getElementById('out-pkp')) document.getElementById('out-pkp').innerText = format(pkp);
            if (document.getElementById('out-tax')) document.getElementById('out-tax').innerText = format(tax);
            if (document.getElementById('out-credit')) document.getElementById('out-credit').innerText = format(credit);
            
            const elStat = document.getElementById('out-status');
            if (document.getElementById('out-balance')) document.getElementById('out-balance').innerText = "Rp " + format(Math.abs(balance));

            if (elStat) {
                if(balance > 0) { elStat.innerText = "KURANG BAYAR"; elStat.className = "text-2xl font-extrabold text-red-400"; }
                else if(balance < 0) { elStat.innerText = "LEBIH BAYAR"; elStat.className = "text-2xl font-extrabold text-yellow-400"; }
                else { elStat.innerText = "NIHIL"; elStat.className = "text-2xl font-extrabold text-gray-400"; }
            }
        }

        function downloadCSV() {
            const badgeText = document.getElementById('balance-badge').innerText;
            if (badgeText.includes("SELISIH")) {
                alert("PERINGATAN: Neraca tidak seimbang. Mohon perbaiki data aset/kewajiban sebelum download.");
                return;
            }
            alert("Generating CSV L1 (Laba Rugi & Neraca), Induk, dan Kredit Pajak...");
        }

        // Init
        runEngine();
    </script>
</body>
</html>
